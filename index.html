<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JOLIE PAS CHER</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#5D5CDE',
            secondary: '#FFD700',
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen transition-colors duration-300 bg-gradient-to-br from-blue-600 via-cyan-400 to-blue-600 dark:from-blue-900 dark:via-cyan-900 dark:to-blue-900">

<!-- Loading Screen -->
<div id="loading-screen" class="fixed inset-0 z-[10000] bg-gradient-to-br from-blue-600 via-cyan-400 to-blue-600 dark:from-blue-900 dark:via-cyan-900 dark:to-blue-900 flex items-center justify-center">
  <div class="text-center">
    <img src="https://i.postimg.cc/9Xx6XHrD/Screenshot-20250525-094331.png" alt="Logo" class="w-32 h-32 mx-auto mb-8 animate-bounce">
    <h1 class="text-5xl md:text-6xl font-bold text-white mb-4 drop-shadow-2xl">JOLIE PAS CHER</h1>
    <p class="text-xl text-white/90 mb-8">Chargement en cours...</p>
    <div class="flex justify-center gap-2">
      <div class="w-4 h-4 bg-yellow-400 rounded-full animate-pulse" style="animation-delay: 0s"></div>
      <div class="w-4 h-4 bg-yellow-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
      <div class="w-4 h-4 bg-yellow-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
    </div>
  </div>
</div>

<!-- Header -->
<header class="sticky top-0 z-50 bg-white dark:bg-gray-800 shadow-lg transition-colors duration-300">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img src="https://i.postimg.cc/9Xx6XHrD/Screenshot-20250525-094331.png" alt="Logo" class="h-12 w-12 object-contain">
      <h1 class="text-xl md:text-2xl font-bold text-gray-900 dark:text-white">JOLIE PAS CHER</h1>
    </div>

    <button onclick="toggleMenu()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
      <svg class="w-6 h-6 text-gray-900 dark:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>
  </div>

  <!-- Menu -->
  <div id="menu" class="hidden bg-gradient-to-b from-gray-900 to-blue-900 text-white">
    <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col gap-2">
      <button onclick="showSection('accueil')" class="px-4 py-3 rounded-lg hover:bg-white/10 transition-all text-left text-base">🏠 Accueil</button>
      <button onclick="showSection('boutique')" class="px-4 py-3 rounded-lg hover:bg-white/10 transition-all text-left text-base">🛍️ Boutique</button>
      <button onclick="showSection('panier')" class="px-4 py-3 rounded-lg hover:bg-white/10 transition-all text-left text-base">🛒 Panier</button>
      <button id="messages-menu-btn" onclick="showSection('messages')" class="hidden px-4 py-3 rounded-lg hover:bg-white/10 transition-all text-left text-base relative">💬 Messages <span id="unread-badge" class="hidden absolute top-2 right-2 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center"></span></button>
      <button id="admin-menu-btn" onclick="showSection('admin')" class="hidden px-4 py-3 rounded-lg bg-red-600 hover:bg-red-700 transition-all text-left text-base font-bold">⚙️ Administrateur</button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">

  <!-- Section Accueil -->
  <section id="accueil" class="section active">
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-4 drop-shadow-lg">Bienvenue sur Jolie Pas Cher</h1>
      <p class="text-xl md:text-2xl text-white/90">Découvrez des produits <strong>uniques</strong> à petit prix !</p>
    </div>

    <div class="flex justify-center mb-8">
      <a href="https://poe.com/Har22fragpt" target="_blank" class="px-6 py-3 bg-blue-600 hover:bg-yellow-400 text-white hover:text-gray-900 rounded-lg font-bold text-base md:text-lg transition-all transform hover:scale-105 shadow-lg uppercase">
        💬 Discute avec le S (sur Poe)
      </a>
    </div>

    <div class="flex justify-center mb-8">
      <iframe
        src="https://www.instagram.com/reel/DGvmGEgNK-c/embed/?autoplay=1&hidecaption=1&controls=0"
        width="400"
        height="350"
        frameborder="0"
        scrolling="no"
        allow="autoplay; encrypted-media"
        class="rounded-lg shadow-2xl max-w-full">
      </iframe>
    </div>

    <div class="space-y-6 bg-white/10 dark:bg-black/20 backdrop-blur-sm rounded-2xl p-6 md:p-8">
      <h2 class="text-3xl font-bold text-yellow-400 text-center mb-6">🎵 Meilleures Musiques</h2>

      <div class="space-y-4">
        <div class="bg-white/5 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-white mb-2">Frank le bœuf</h3>
          <iframe width="100%" height="60" src="https://vocaroo.com/embed/1omwth55KSLT?autoplay=1" frameborder="0" allow="autoplay" class="rounded"></iframe>
        </div>

        <div class="bg-white/5 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-white mb-2">Band organise samba</h3>
          <iframe width="100%" height="60" src="https://vocaroo.com/embed/1ghiDBHLVRtn?autoplay=0" frameborder="0" allow="autoplay" class="rounded"></iframe>
        </div>

        <div class="bg-white/5 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-white mb-2">Journal 2 20h02</h3>
          <iframe width="100%" height="60" src="https://vocaroo.com/embed/1bKOLORGf4GO?autoplay=0" frameborder="0" allow="autoplay" class="rounded"></iframe>
        </div>

        <div class="bg-white/5 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-white mb-2">Vendez votre Frank Lebœuf</h3>
          <iframe width="100%" height="60" src="https://vocaroo.com/embed/1fLLgpWY9xxo?autoplay=0" frameborder="0" allow="autoplay" class="rounded"></iframe>
        </div>
      </div>
    </div>
  </section>

  <!-- Section Boutique -->
  <section id="boutique" class="section">
    <div class="mb-8 text-center">
      <input
        type="text"
        id="recherche"
        oninput="filtrerArticles()"
        placeholder="🔍 Rechercher un article..."
        class="w-full max-w-md px-6 py-3 rounded-full border-2 border-white/30 bg-white/90 dark:bg-gray-800 dark:text-white text-base focus:outline-none focus:ring-2 focus:ring-primary shadow-lg">
    </div>

    <div id="articles-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
  </section>

  <!-- Section Panier -->
  <section id="panier" class="section">
    <h2 class="text-3xl md:text-4xl font-bold text-white text-center mb-8">🛒 Votre panier</h2>

    <!-- Login Section -->
    <div id="login-section" class="mb-8 space-y-6">
      <div class="bg-white/10 dark:bg-black/20 backdrop-blur-sm rounded-2xl p-6 md:p-8 text-center">
        <h3 class="text-2xl font-bold text-yellow-400 mb-4">🔍 Connexion rapide par QR Code</h3>
        <p class="text-white mb-6">Scannez votre QR code personnel pour vous connecter automatiquement !</p>
        <button onclick="startQRScanner()" class="px-6 py-3 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-full text-base md:text-lg font-bold hover:scale-105 transition-transform shadow-lg">
          📷 Scanner QR Code
        </button>
      </div>

      <div class="text-center">
        <button onclick="toggleClassicLogin()" class="px-6 py-3 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/30 transition-all">
          🔑 Connexion classique
        </button>

        <form id="classic-login-form" class="hidden mt-4 max-w-sm mx-auto bg-white/10 backdrop-blur-sm rounded-lg p-6 space-y-4" onsubmit="handleClassicLogin(event)">
          <input name="identifiant" type="text" placeholder="Identifiant" required class="w-full px-4 py-2 rounded-lg border-none bg-white dark:bg-gray-800 dark:text-white text-base focus:ring-2 focus:ring-primary">
          <input name="motDePasse" type="password" placeholder="Mot de passe" required class="w-full px-4 py-2 rounded-lg border-none bg-white dark:bg-gray-800 dark:text-white text-base focus:ring-2 focus:ring-primary">
          <button type="submit" class="w-full px-4 py-2 bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold rounded-lg transition-colors">Se connecter</button>
          <div id="login-error" class="text-red-400 text-sm"></div>
        </form>
      </div>
    </div>

    <!-- QR Code Verification Overlay -->
    <div id="qr-code-verification-overlay" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
      <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 md:p-8 max-w-md w-full">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">🔒 Vérification du code secret</h3>
        <p id="qr-user-prompt" class="text-gray-700 dark:text-gray-300 mb-6">Veuillez entrer votre code secret.</p>
        <form id="qr-verify-form" onsubmit="handleQRVerify(event)" class="space-y-4">
          <input type="password" id="qr-secret-code" placeholder="Code Secret" required class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base focus:ring-2 focus:ring-primary">
          <button type="submit" class="w-full px-4 py-2 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-colors">Valider le Code</button>
          <div id="qr-verify-error" class="text-red-500 text-sm"></div>
        </form>
        <button onclick="cancelQRVerify()" class="w-full mt-4 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
          ❌ Annuler
        </button>
      </div>
    </div>

    <!-- QR Scanner Overlay -->
    <div id="qr-scanner-overlay" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4">
      <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 md:p-8 max-w-lg w-full">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 text-center">🔍 Scanner votre QR Code</h3>
        <div class="relative w-full max-w-sm mx-auto mb-6">
          <div class="relative border-4 border-green-500 rounded-2xl overflow-hidden aspect-square">
            <video id="qr-video" autoplay playsinline class="w-full h-full object-cover"></video>
            <canvas id="qr-canvas" class="hidden"></canvas>
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
              <div class="w-48 h-48 border-2 border-green-500 rounded-xl shadow-[0_0_0_9999px_rgba(0,0,0,0.3)] animate-pulse"></div>
            </div>
          </div>
        </div>
        <p id="scan-message" class="text-center text-gray-700 dark:text-gray-300 font-semibold mb-4">Initialisation...</p>
        <button onclick="stopQRScanner()" class="w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg transition-colors">
          ❌ Fermer
        </button>
      </div>
    </div>

    <!-- User Dashboard -->
    <div id="user-dashboard" class="hidden mb-8 space-y-6">
      <div class="bg-green-500/20 border-l-4 border-green-500 rounded-lg p-4 md:p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="text-white">
          <p class="text-base md:text-lg">✅ Connecté en tant que: <strong id="user-name" class="text-yellow-400"></strong></p>
          <p class="text-base md:text-lg">💰 Solde: <strong id="user-balance" class="text-yellow-400"></strong> cailloux</p>
        </div>
        <button onclick="logout()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors self-start md:self-auto">
          🚪 Déconnexion
        </button>
      </div>

      <div class="bg-white/10 dark:bg-black/20 backdrop-blur-sm rounded-2xl p-6">
        <h3 class="text-xl font-bold text-yellow-400 mb-4">💸 Envoyer des cailloux</h3>
        <form onsubmit="envoyerCailloux(event)" class="flex flex-col md:flex-row gap-3">
          <input name="destinataire" type="text" placeholder="Identifiant du destinataire" required class="flex-1 px-4 py-2 rounded-lg border-none bg-white dark:bg-gray-800 dark:text-white text-base focus:ring-2 focus:ring-primary">
          <input name="montant" type="number" placeholder="Montant" min="1" required class="flex-1 px-4 py-2 rounded-lg border-none bg-white dark:bg-gray-800 dark:text-white text-base focus:ring-2 focus:ring-primary">
          <button type="submit" class="px-6 py-2 bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold rounded-lg transition-colors">Envoyer</button>
        </form>
      </div>

      <div class="bg-white/10 dark:bg-black/20 backdrop-blur-sm rounded-2xl p-6">
        <h3 class="text-xl font-bold text-yellow-400 mb-4">🎫 Code Créateur</h3>
        <input type="text" placeholder="Entrez le code créateur" onkeypress="handleCodeInput(event)" class="w-full px-4 py-2 rounded-lg border-none bg-white dark:bg-gray-800 dark:text-white text-base focus:ring-2 focus:ring-primary">
        <div id="code-success" class="hidden mt-3 text-green-400 font-bold"></div>
      </div>

      <div class="bg-white/10 dark:bg-black/20 backdrop-blur-sm rounded-2xl p-6">
        <h3 class="text-xl font-bold text-yellow-400 mb-4">⚙️ Paramètres du compte</h3>
        <button onclick="afficherParametresCompte()" class="w-full px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg transition-colors">
          🔧 Modifier mon email / mot de passe
        </button>
      </div>
    </div>

    <!-- Cart Content -->
    <div class="bg-white/10 dark:bg-black/20 backdrop-blur-sm rounded-2xl p-6 md:p-8">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-white">🛒 Articles dans le panier</h3>
        <button id="clear-cart-button" onclick="viderPanier()" class="hidden px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all text-sm">
          🗑️ Vider
        </button>
      </div>
      <div id="empty-cart" class="text-center text-white/70 italic py-8">Votre panier est vide</div>
      <ul id="liste-panier" class="hidden space-y-2 mb-6"></ul>
      <p id="total-panier" class="hidden text-2xl font-bold text-yellow-400 text-center mb-6">Total : 0 cailloux</p>
      <button id="buy-button" onclick="acheter()" class="hidden w-full md:w-auto mx-auto block px-8 py-3 bg-gradient-to-r from-red-500 to-cyan-500 text-white font-bold rounded-full text-base md:text-lg hover:scale-105 transition-transform shadow-lg">
        💳 Acheter
      </button>
    </div>

    <!-- Historique des commandes -->
    <div id="order-history" class="hidden mt-8 bg-white/10 dark:bg-black/20 backdrop-blur-sm rounded-2xl p-6 md:p-8">
      <h3 class="text-2xl font-bold text-white mb-6">📜 Historique de vos commandes</h3>
      <div id="history-list"></div>
    </div>
  </section>

  <!-- Section Messages -->
  <section id="messages" class="section">
    <h2 class="text-3xl md:text-4xl font-bold text-white text-center mb-8">💬 Messages</h2>

    <!-- Connexion requise -->
    <div id="messages-login-required" class="bg-white/10 dark:bg-black/20 backdrop-blur-sm rounded-2xl p-6 md:p-8 text-center">
      <p class="text-white text-lg mb-4">Connectez-vous pour accéder à la messagerie !</p>
      <button onclick="showSection('panier')" class="px-6 py-3 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-colors">
        Se connecter
      </button>
    </div>

    <!-- Interface de messagerie -->
    <div id="messages-interface" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Liste des utilisateurs -->
        <div class="lg:col-span-1 bg-white/10 dark:bg-black/20 backdrop-blur-sm rounded-2xl p-4">
          <div class="mb-4">
            <h3 class="text-xl font-bold text-white mb-4">👥 Utilisateurs</h3>

            <!-- Photo de profil -->
            <div class="bg-white/5 rounded-lg p-4 mb-4 text-center">
              <div class="relative inline-block mb-2">
                <img id="user-profile-pic" src="https://ui-avatars.com/api/?name=User&background=5D5CDE&color=fff&size=128" alt="Photo de profil" class="w-20 h-20 rounded-full mx-auto border-4 border-green-500">
                <button onclick="changerPhotoProfil()" class="absolute bottom-0 right-0 bg-primary hover:bg-primary/80 text-white rounded-full w-8 h-8 flex items-center justify-center transition-colors">
                  ✏️
                </button>
              </div>
              <p class="text-white font-bold" id="messages-username"></p>
              <p class="text-green-400 text-sm">● En ligne</p>
            </div>
          </div>

          <!-- Recherche utilisateurs -->
          <input type="text" id="user-search" oninput="filtrerUtilisateurs()" placeholder="🔍 Rechercher..." class="w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 dark:text-white text-base mb-4 focus:ring-2 focus:ring-primary">

          <!-- Liste des conversations -->
          <div id="users-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
        </div>

        <!-- Zone de conversation -->
        <div class="lg:col-span-2 bg-white/10 dark:bg-black/20 backdrop-blur-sm rounded-2xl p-4 flex flex-col" style="height: 600px;">

          <!-- Message de bienvenue -->
          <div id="no-conversation-selected" class="flex-1 flex items-center justify-center">
            <div class="text-center text-white/70">
              <p class="text-4xl mb-4">💬</p>
              <p class="text-lg">Sélectionnez une conversation</p>
            </div>
          </div>

          <!-- Conversation active -->
          <div id="active-conversation" class="hidden flex flex-col h-full">
            <!-- En-tête conversation -->
            <div class="bg-white/5 rounded-lg p-4 mb-4 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <img id="conv-user-pic" src="" alt="" class="w-12 h-12 rounded-full border-2 border-green-500">
                <div>
                  <p class="text-white font-bold" id="conv-username"></p>
                  <p class="text-sm" id="conv-status"><span class="text-green-400">● En ligne</span></p>
                </div>
              </div>
              <button onclick="fermerConversation()" class="text-white hover:text-red-400 transition-colors">✕</button>
            </div>

            <!-- Messages -->
            <div id="messages-container" class="flex-1 overflow-y-auto space-y-3 mb-4 px-2"></div>

            <!-- Input message -->
            <div class="bg-white/5 rounded-lg p-3">
              <div class="flex gap-2 mb-2">
                <button onclick="ajouterImage()" class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-sm" title="Ajouter une image">
                  🖼️
                </button>
                <button onclick="ajouterGif()" class="px-3 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors text-sm" title="Ajouter un GIF">
                  GIF
                </button>
                <button onclick="ajouterVideo()" class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors text-sm" title="Ajouter une vidéo">
                  🎥
                </button>
              </div>
              <div class="flex gap-2">
                <input type="text" id="message-input" placeholder="Écrivez votre message..." class="flex-1 px-4 py-2 rounded-lg bg-white dark:bg-gray-800 dark:text-white text-base focus:ring-2 focus:ring-primary" onkeypress="handleMessageKeyPress(event)">
                <button onclick="envoyerMessage()" class="px-6 py-2 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-colors">
                  Envoyer
                </button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Section Admin -->
  <section id="admin" class="section">
    <h1 class="text-4xl md:text-5xl font-bold text-white text-center mb-8">⚙️ Panneau Administrateur</h1>

    <!-- Gestion des thèmes -->
    <div class="bg-gradient-to-br from-red-600 to-purple-600 rounded-2xl p-6 md:p-8 mb-8 shadow-2xl">
      <h2 class="text-3xl font-bold text-white mb-6">🎨 Gestion des Événements</h2>

      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
        <button onclick="changerTheme('halloween')" class="bg-orange-500 hover:bg-orange-600 text-white p-4 rounded-xl font-bold transition-all transform hover:scale-105">
          🎃 Halloween
        </button>
        <button onclick="changerTheme('noel')" class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-xl font-bold transition-all transform hover:scale-105">
          🎄 Noël
        </button>
        <button onclick="changerTheme('paques')" class="bg-pink-400 hover:bg-pink-500 text-white p-4 rounded-xl font-bold transition-all transform hover:scale-105">
          🐰 Pâques
        </button>
        <button onclick="changerTheme('nouvel-an')" class="bg-yellow-500 hover:bg-yellow-600 text-white p-4 rounded-xl font-bold transition-all transform hover:scale-105">
          🎆 Nouvel An
        </button>
        <button onclick="changerTheme('st-valentin')" class="bg-pink-600 hover:bg-pink-700 text-white p-4 rounded-xl font-bold transition-all transform hover:scale-105">
          💕 St Valentin
        </button>
        <button onclick="changerTheme('ldc')" class="bg-blue-800 hover:bg-blue-900 text-white p-4 rounded-xl font-bold transition-all transform hover:scale-105">
          ⚽ LDC
        </button>
        <button onclick="changerTheme('ballon-dor')" class="bg-yellow-600 hover:bg-yellow-700 text-white p-4 rounded-xl font-bold transition-all transform hover:scale-105">
          🏆 Ballon d'Or
        </button>
        <button onclick="changerTheme('coupe-monde')" class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-xl font-bold transition-all transform hover:scale-105">
          🏆 Coupe du Monde
        </button>
        <button onclick="changerTheme('normal')" class="bg-gray-600 hover:bg-gray-700 text-white p-4 rounded-xl font-bold transition-all transform hover:scale-105 col-span-2">
          ⭐ Thème Normal
        </button>
      </div>

      <div class="bg-white/20 rounded-lg p-4">
        <p class="text-white"><strong>Thème actuel :</strong> <span id="current-theme" class="text-yellow-300">Normal</span></p>
        <p class="text-white"><strong>Réduction active :</strong> <span id="current-reduction" class="text-yellow-300">0%</span></p>
      </div>
    </div>

    <!-- Gestion des cailloux -->
    <div class="bg-white/10 dark:bg-black/20 backdrop-blur-sm rounded-2xl p-6 md:p-8 mb-8">
      <h2 class="text-3xl font-bold text-yellow-400 mb-6">💰 Gestion des Cailloux</h2>

      <form onsubmit="ajouterCailloux(event)" class="space-y-4">
        <div>
          <label class="block text-white font-semibold mb-2">Utilisateur</label>
          <input type="text" name="username" placeholder="Nom d'utilisateur (ex: MAXIME)" required class="w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 dark:text-white text-base focus:ring-2 focus:ring-yellow-400">
        </div>

        <div>
          <label class="block text-white font-semibold mb-2">Montant (positif pour ajouter, négatif pour retirer)</label>
          <input type="number" name="montant" placeholder="Ex: 1000 ou -500" required class="w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 dark:text-white text-base focus:ring-2 focus:ring-yellow-400">
        </div>

        <button type="submit" class="w-full px-6 py-3 bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold rounded-lg transition-all text-lg">
          💸 Modifier le solde
        </button>
      </form>
    </div>

    <!-- Gestion des produits -->
    <div class="bg-white/10 dark:bg-black/20 backdrop-blur-sm rounded-2xl p-6 md:p-8">
      <h2 class="text-3xl font-bold text-yellow-400 mb-6">📦 Ajouter un Produit</h2>

      <form onsubmit="ajouterProduit(event)" class="space-y-4">
        <div>
          <label class="block text-white font-semibold mb-2">Nom du produit</label>
          <input type="text" name="nom" placeholder="Ex: Super Stylo" required class="w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 dark:text-white text-base focus:ring-2 focus:ring-yellow-400">
        </div>

        <div>
          <label class="block text-white font-semibold mb-2">Prix (en cailloux)</label>
          <input type="number" name="prix" placeholder="Ex: 50" min="1" required class="w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 dark:text-white text-base focus:ring-2 focus:ring-yellow-400">
        </div>

        <div>
          <label class="block text-white font-semibold mb-2">Type</label>
          <select name="type" onchange="toggleImageUrl(this.value)" class="w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 dark:text-white text-base focus:ring-2 focus:ring-yellow-400">
            <option value="emoji">Emoji</option>
            <option value="image">Image</option>
          </select>
        </div>

        <div id="emoji-input">
          <label class="block text-white font-semibold mb-2">Emoji</label>
          <input type="text" name="emoji" placeholder="Ex: 🎨" class="w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 dark:text-white text-base focus:ring-2 focus:ring-yellow-400">
        </div>

        <div id="image-input" class="hidden">
          <label class="block text-white font-semibold mb-2">URL de l'image</label>
          <input type="url" name="imageUrl" placeholder="https://..." class="w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 dark:text-white text-base focus:ring-2 focus:ring-yellow-400">
        </div>

        <div class="bg-orange-500/20 border border-orange-500 rounded-lg p-4">
          <label class="flex items-center gap-3 cursor-pointer">
            <input type="checkbox" id="produit-limite" class="w-5 h-5 rounded border-orange-500 text-orange-600 focus:ring-orange-500">
            <div>
              <span class="text-white font-bold">⏰ Produit limité (1 jour)</span>
              <p class="text-sm text-white/80">Le produit disparaîtra automatiquement après 24h</p>
            </div>
          </label>
        </div>

        <button type="submit" class="w-full px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition-all text-lg">
          ➕ Ajouter le produit
        </button>
      </form>
    </div>
  </section>

</main>

<!-- Modal Container -->
<div id="modal-container"></div>

<style>
  .section {
    display: none;
  }
  .section.active {
    display: block;
  }
</style>

<script>
// Dark mode setup
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
  if (event.matches) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }
});

// Configuration Firebase (VOS VRAIES CLÉS)
const firebaseConfig = {
  apiKey: "AIzaSyDUztozKsSV8b1imdc9YWw0CL_RlPmIKPk",
  authDomain: "jolie-pas-cher.firebaseapp.com",
  projectId: "jolie-pas-cher",
  storageBucket: "jolie-pas-cher.firebasestorage.app",
  messagingSenderId: "835428667735",
  appId: "1:835428667735:web:8c52a5fe6dd312340c2e12",
  measurementId: "G-JJ64ZQQDG9"
};

// Initialiser Firebase
let db = null;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  console.log("✅ Firebase connecté");
} catch (error) {
  console.warn("⚠️ Firebase non disponible, mode hors ligne activé");
}

// Variables globales
let panier = [];
let utilisateurConnecte = null;
let codeValide = false;
let reduction = 0;
let qrScannerActive = false;
let animationId = null;
let tempQRUser = null;
let historique = {};
let themeActuel = 'normal';
let reductionGlobale = 0;

// Fonction pour générer un numéro de commande aléatoire
function genererNumeroCommande() {
  const prefix = 'JPC'; // JOLIE PAS CHER
  const timestamp = Date.now().toString().slice(-6); // 6 derniers chiffres du timestamp
  const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
  return `${prefix}-${timestamp}-${random}`;
}

// Sauvegarder le panier
function sauvegarderPanier() {
  updateCartBadge();
}

// Mettre à jour le badge du panier
function updateCartBadge() {
  const totalItems = panier.reduce((sum, item) => sum + item.quantité, 0);
  let badge = document.getElementById('cart-badge');

  if (!badge && totalItems > 0) {
    badge = document.createElement('span');
    badge.id = 'cart-badge';
    badge.className = 'absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center animate-bounce';
    document.querySelector('button[onclick="showSection(\'panier\')"]').style.position = 'relative';
    document.querySelector('button[onclick="showSection(\'panier\')"]').appendChild(badge);
  }

  if (badge) {
    badge.textContent = totalItems;
    if (totalItems === 0) {
      badge.remove();
    }
  }
}

// Système de notifications toast
function showToast(message, type = 'info') {
  const colors = {
    success: 'bg-green-500',
    error: 'bg-red-500',
    info: 'bg-blue-500',
    warning: 'bg-yellow-500'
  };

  const toast = document.createElement('div');
  toast.className = `fixed top-24 right-4 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-2xl z-[9999] transform translate-x-[400px] transition-all duration-500 max-w-sm`;
  toast.innerHTML = `
    <div class="flex items-center gap-3">
      <span class="text-2xl">${type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}</span>
      <p class="font-semibold">${message}</p>
    </div>
  `;

  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.transform = 'translateX(0)';
  }, 100);

  setTimeout(() => {
    toast.style.transform = 'translateX(400px)';
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}

const webhookURL = "https://discord.com/api/webhooks/1380578654093971527/50tQAtRKwQH0Fmktz1EunnhfJKyIbaBnXosQFRJGnCrNcp8BlvBHZWF7SXoFW3KzElfR";

const codes = {
  "OUI": 10,
  "UNCHAINED": 10,
  "CAMILLE": 20,
  "VIVLESSCOOTERETMAZDANIQUELESSALOPESQUIPARLENTENSCREDICICMARSEILLELARUELAVRAIVIVELESONOMATOPE": 30,
  "WSXBOEXNE01IXR3738Z9F2ONF7CN48383Y8D8D9EJ22I29DLDNSLLSMDCF7R783839399ECBF5R9012NNDKDLDODO": 40,
  "E9WBE9D3D83D4VDU4D5DUI8D0EH34J84KEVRI39DB38EOEBED9DJEJE0ZL'ZAMAMDVDUD9EO3282O393O3BDIZOZOZKDKEJC4U48388FIFUFUFUD6754F7F93B3BB33901010JKSSBZJZ9ZO": 99
};

// Utilisateurs par défaut (fallback si Firebase ne fonctionne pas)
const utilisateursDefaut = {
  "HARMAN": { solde: 100000000000, motDePasse: "1234" },
  "ALEXANDRE": { solde: 100000000, motDePasse: "bonjour" },
  "ADMIN": { solde: 999999999999, motDePasse: "Dasntesreve" },
  "MAXIME": { solde: 10, motDePasse: "football" },
  "GABRIEL": { solde: 10, motDePasse: "con" },
  "ELWEN": { solde: 10, motDePasse: "5678" },
  "PANA": { solde: 10, motDePasse: "Salut" },
  "ENEA": { solde: 10, motDePasse: "Messi" },
  "CHARLIE": { solde: 10, motDePasse: "1328" },
  "LOUIS": { solde: 110, motDePasse: "Loup" },
  "GANZAGUE": { solde: 10, motDePasse: "Algue" },
  "HUGO": { solde: 10, motDePasse: "salut123" },
  "LENNY": { solde: 10, motDePasse: "coucou" },
  "GREGOIRE": { solde: 10, motDePasse: "argent" },
  "SULLIVAN": { solde: 10, motDePasse: "Barca" },
  "WAYS": { solde: 10, motDePasse: "colle" },
  "CAMILLE": { solde: 10, motDePasse: "fille" },
  "MATHIEU": { solde: 10, motDePasse: "Banane" },
  "GURMAN": { solde: 10, motDePasse: "Gourmand" },
  "NOELIE": { solde: 10600, motDePasse: "Super" },
  "VICTOR": { solde: 1600, motDePasse: "frites" }
};

let utilisateurs = {...utilisateursDefaut};
let conversations = {};
let conversationActive = null;
let utilisateursEnLigne = new Set();
let messagesNonLus = {};

// Initialiser les utilisateurs dans Firebase
async function initialiserUtilisateurs() {
  if (!db) return;

  try {
    for (const [username, data] of Object.entries(utilisateursDefaut)) {
      const userRef = db.collection('utilisateurs').doc(username);
      const doc = await userRef.get();

      if (!doc.exists) {
        await userRef.set({
          solde: data.solde,
          motDePasse: data.motDePasse,
          email: null,
          emailVerifie: false,
          createdAt: new Date()
        });
      }
    }

    // Charger tous les utilisateurs depuis Firebase
    await chargerUtilisateurs();

    // Charger les paramètres globaux (thème, réduction)
    await chargerParametresGlobaux();

    // Charger les articles depuis Firebase
    await chargerArticles();

    // Activer l'écoute en temps réel
    ecouterUtilisateurs();
    ecouterParametresGlobaux();
    ecouterArticles();
  } catch (error) {
    console.warn("Erreur init Firebase:", error);
  }
}

// Charger les utilisateurs depuis Firebase
async function chargerUtilisateurs() {
  if (!db) return;

  try {
    const snapshot = await db.collection('utilisateurs').get();
    snapshot.forEach(doc => {
      utilisateurs[doc.id] = doc.data();
    });
  } catch (error) {
    console.warn("Erreur chargement utilisateurs:", error);
  }
}

// Écouter les changements en temps réel des utilisateurs
function ecouterUtilisateurs() {
  if (!db) return;

  db.collection('utilisateurs').onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      const username = change.doc.id;
      const data = change.doc.data();

      if (change.type === 'modified' || change.type === 'added') {
        utilisateurs[username] = data;

        // Mettre à jour l'affichage si c'est l'utilisateur connecté
        if (utilisateurConnecte === username) {
          updateUserDisplay();
        }
      }
    });
  }, error => {
    console.warn("Erreur écoute utilisateurs:", error);
  });
}

// Mettre à jour le solde dans Firebase
async function mettreAJourSolde(username, nouveauSolde) {
  if (!db) {
    utilisateurs[username].solde = nouveauSolde;
    return;
  }

  try {
    await db.collection('utilisateurs').doc(username).update({
      solde: nouveauSolde
    });
    utilisateurs[username].solde = nouveauSolde;
  } catch (error) {
    console.warn("Erreur MAJ solde:", error);
    utilisateurs[username].solde = nouveauSolde;
  }
}

// Sauvegarder une commande dans Firebase
async function sauvegarderCommande(commande) {
  if (!db) return;

  try {
    await db.collection('commandes').add({
      ...commande,
      timestamp: new Date()
    });
  } catch (error) {
    console.warn("Erreur sauvegarde commande:", error);
  }
}

// Charger l'historique depuis Firebase
async function chargerHistorique(username) {
  if (!db) return;

  try {
    const snapshot = await db.collection('commandes')
      .where('utilisateur', '==', username)
      .orderBy('timestamp', 'desc')
      .get();

    historique[username] = [];
    snapshot.forEach(doc => {
      historique[username].push(doc.data());
    });

    afficherHistorique();
  } catch (error) {
    console.warn("Erreur chargement historique:", error);
  }
}

// Charger les paramètres globaux (thème, réduction)
async function chargerParametresGlobaux() {
  if (!db) return;

  try {
    const doc = await db.collection('parametres').doc('global').get();
    if (doc.exists) {
      const data = doc.data();
      if (data.theme && data.theme !== themeActuel) {
        appliquerTheme(data.theme, data.reduction || 0, false); // false = ne pas sauvegarder à nouveau
      }
    }
  } catch (error) {
    console.warn("Erreur chargement paramètres globaux:", error);
  }
}

// Écouter les changements en temps réel des paramètres globaux
function ecouterParametresGlobaux() {
  if (!db) return;

  db.collection('parametres').doc('global').onSnapshot(doc => {
    if (doc.exists) {
      const data = doc.data();
      if (data.theme !== themeActuel || data.reduction !== reductionGlobale) {
        appliquerTheme(data.theme, data.reduction || 0, false);
      }
    }
  }, error => {
    console.warn("Erreur écoute paramètres:", error);
  });
}

// Charger les articles depuis Firebase
async function chargerArticles() {
  if (!db) return;

  try {
    const snapshot = await db.collection('articles').get();
    const articlesFromDB = [];

    snapshot.forEach(doc => {
      const data = doc.data();

      // Vérifier si l'article est limité et encore valide
      if (data.limite && data.expireAt) {
        const expireDate = data.expireAt.toDate();
        if (new Date() > expireDate) {
          // Article expiré, le supprimer
          db.collection('articles').doc(doc.id).delete();
          return; // Ne pas ajouter cet article
        }
      }

      articlesFromDB.push({ id: doc.id, ...data });
    });

    // Fusionner avec les articles par défaut
    articles = [...articlesFromDB];
    afficherArticles();
  } catch (error) {
    console.warn("Erreur chargement articles:", error);
  }
}

// Écouter les changements en temps réel des articles
function ecouterArticles() {
  if (!db) return;

  db.collection('articles').onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      const data = change.doc.data();
      const articleId = change.doc.id;

      if (change.type === 'added' || change.type === 'modified') {
        // Vérifier si limité et expiré
        if (data.limite && data.expireAt) {
          const expireDate = data.expireAt.toDate();
          if (new Date() > expireDate) {
            db.collection('articles').doc(articleId).delete();
            return;
          }
        }

        // Mettre à jour ou ajouter l'article
        const index = articles.findIndex(a => a.id === articleId);
        if (index >= 0) {
          articles[index] = { id: articleId, ...data };
        } else {
          articles.push({ id: articleId, ...data });
        }
      } else if (change.type === 'removed') {
        articles = articles.filter(a => a.id !== articleId);
      }
    });

    afficherArticles();
  }, error => {
    console.warn("Erreur écoute articles:", error);
  });
}

// Sauvegarder les paramètres globaux
async function sauvegarderParametresGlobaux() {
  if (!db) return;

  try {
    await db.collection('parametres').doc('global').set({
      theme: themeActuel,
      reduction: reductionGlobale,
      updatedAt: new Date()
    });
  } catch (error) {
    console.warn("Erreur sauvegarde paramètres globaux:", error);
  }
}

const qrSecretCodes = {
  "HARMAN": "220112",
  "ALEXANDRE": "111111",
  "ADMIN": "000000",
  "MAXIME": "222222",
  "GABRIEL": "333333",
  "ELWEN": "444444",
  "PANA": "555555",
  "CAMILLE": "429203",
  "NOELIE": "123456",
  "VICTOR": "654321",
  "HUGO": "236541"
};

let articles = [
  { nom: "chaise", prix: 10, emoji: "🪑" },
  { nom: "Sac Stylé", prix: 20, emoji: "🎒" },
  { nom: "Lunettes Soleil", prix: 5, emoji: "🕶️" },
  { nom: "Ballon de foot", prix: 5, emoji: "⚽" },
  { nom: "Maxime", prix: 76, img: "https://i.postimg.cc/QMDmBRC5/IMG-20250526-WA0538.jpg" },
  { nom: "Gabriel", prix: 827, img: "https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg" },
  { nom: "Elwen", prix: 937, img: "https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg" },
  { nom: "Panajotis", prix: 246, img: "https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg" },
  { nom: "Alexandre", prix: 903, img: "https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg" },
  { nom: "Stylo", prix: 3, img: "https://i.postimg.cc/pVcmYNnF/79351083-1-ea61-1.jpg"},
  { nom: "Bugatti", prix: 1000, img: "https://i.postimg.cc/bNjM3B2B/875-875-bugatti-chiron-ultime-7544e77c6f8a7a0afe983c01ca597be8.png"},
  { nom: "Enea", prix: 56, img:"https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg"},
  { nom: "Charlie", prix: 527, img:"https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg"},
  { nom: "Louis", prix: 666, img:"https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg"},
  { nom: "Ganzague", prix: 905, img:"https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg"},
  { nom: "Lenny", prix: 934, img:"https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg"},
  { nom: "Grégoire", prix: 656, img:"https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg"},
  { nom: "Sullivan", prix: 434, img:"https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg"},
  { nom: "Ways", prix: 357, img:"https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg"},
  { nom: "Tom", prix: 482, img:"https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg"},
  { nom: "Liam", prix: 563, img:"https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg"},
  { nom: "Wilhelm", prix: 1, img:"https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg"},
  { nom: "Camille", prix: 176, img:"https://i.postimg.cc/nhMRcFDP/IMG-20250609-WA0004.jpg"},
  { nom: "Mathieu", prix: 430, img:"https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg"},
  { nom: "Victor", prix: 500, img:"https://i.postimg.cc/76PJg5pN/5472d1b09d3d724228109d381d617326.jpg"}
];

// Custom Modal Functions (replacing alert/confirm/prompt)
function showAlert(message) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] p-4';
  modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl animate-[scale-in_0.2s_ease-out] transform">
      <p class="text-gray-800 dark:text-gray-200 mb-6 text-base">${message}</p>
      <button class="w-full px-4 py-2 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-colors" onclick="this.closest('.fixed').remove()">
        OK
      </button>
    </div>
  `;
  document.getElementById('modal-container').appendChild(modal);
}

function showConfirm(message, onConfirm) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] p-4';
  modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl">
      <p class="text-gray-800 dark:text-gray-200 mb-6 text-base">${message}</p>
      <div class="flex gap-3">
        <button class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-lg transition-colors" onclick="this.closest('.fixed').remove()">
          Annuler
        </button>
        <button class="flex-1 px-4 py-2 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-colors" onclick="this.closest('.fixed').remove(); (${onConfirm})()">
          Confirmer
        </button>
      </div>
    </div>
  `;
  document.getElementById('modal-container').appendChild(modal);
}

// Navigation
function toggleMenu() {
  document.getElementById("menu").classList.toggle("hidden");
}

function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.getElementById("menu").classList.add("hidden");

  // Si on ouvre la section messages
  if (id === 'messages') {
    if (utilisateurConnecte) {
      document.getElementById('messages-login-required').classList.add('hidden');
      document.getElementById('messages-interface').classList.remove('hidden');
    } else {
      document.getElementById('messages-login-required').classList.remove('hidden');
      document.getElementById('messages-interface').classList.add('hidden');
    }
  }
}

function sendWebhook(message) {
  fetch(webhookURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ content: message })
  }).catch(err => console.warn("Erreur Webhook:", err));
}

// Articles
function afficherArticles(liste = articles) {
  const container = document.getElementById("articles-container");
  container.innerHTML = "";
  liste.forEach(article => {
    const div = document.createElement("div");
    div.className = "bg-gradient-to-br from-blue-900 to-cyan-700 rounded-2xl p-6 shadow-xl hover:shadow-2xl transform hover:-translate-y-2 transition-all duration-300 relative";

    // Badge "LIMITÉ" si l'article est limité
    let badgeLimite = '';
    if (article.limite && article.expireAt) {
      const expireDate = article.expireAt.toDate ? article.expireAt.toDate() : new Date(article.expireAt);
      const heuresRestantes = Math.max(0, Math.round((expireDate - new Date()) / (1000 * 60 * 60)));
      badgeLimite = `
        <div class="absolute top-2 right-2 bg-red-600 text-white px-3 py-1 rounded-full text-sm font-bold animate-pulse">
          ⏰ ${heuresRestantes}h restantes
        </div>
      `;
    }

    if (article.img) {
      div.innerHTML = `
        ${badgeLimite}
        <img src="${article.img}" alt="${article.nom}" class="w-full h-48 object-cover rounded-xl mb-4">
        <h3 class="text-xl font-bold text-white mb-2">${article.nom}</h3>
        <p class="text-2xl font-bold text-yellow-400 mb-4">${article.prix} cailloux</p>
        <button onclick="ajouterAuPanier('${article.nom.replace(/'/g, "\\'")}', ${article.prix})" class="w-full px-4 py-2 bg-white hover:bg-yellow-400 text-blue-900 font-bold rounded-lg transition-all transform hover:scale-105">
          Ajouter au panier
        </button>
      `;
    } else {
      div.innerHTML = `
        ${badgeLimite}
        <div class="text-6xl text-center mb-4">${article.emoji}</div>
        <h3 class="text-xl font-bold text-white mb-2 text-center">${article.nom}</h3>
        <p class="text-2xl font-bold text-yellow-400 mb-4 text-center">${article.prix} cailloux</p>
        <button onclick="ajouterAuPanier('${article.nom.replace(/'/g, "\\'")}', ${article.prix})" class="w-full px-4 py-2 bg-white hover:bg-yellow-400 text-blue-900 font-bold rounded-lg transition-all transform hover:scale-105">
          Ajouter au panier
        </button>
      `;
    }
    container.appendChild(div);
  });
}

function filtrerArticles() {
  const recherche = document.getElementById("recherche").value.toLowerCase();
  const filtres = articles.filter(a => a.nom.toLowerCase().includes(recherche));
  afficherArticles(filtres);
}

// Panier
function ajouterAuPanier(nom, prix) {
  // Demander la quantité avec une modale personnalisée
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] p-4';
  modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">🛒 ${nom}</h3>
      <p class="text-gray-700 dark:text-gray-300 mb-4">Combien voulez-vous en acheter ?</p>
      <input type="number" id="quantity-input" min="1" value="1" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base mb-4 focus:ring-2 focus:ring-primary">
      <div class="flex gap-3">
        <button class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-lg transition-colors" onclick="this.closest('.fixed').remove()">
          Annuler
        </button>
        <button class="flex-1 px-4 py-2 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-colors" onclick="confirmerAjoutPanier('${nom}', ${prix}, parseInt(document.getElementById('quantity-input').value)); this.closest('.fixed').remove()">
          Ajouter
        </button>
      </div>
    </div>
  `;
  document.getElementById('modal-container').appendChild(modal);
  // Focus sur l'input
  setTimeout(() => document.getElementById('quantity-input').focus(), 100);
}

function confirmerAjoutPanier(nom, prix, quantite) {
  if (quantite < 1) quantite = 1;

  const item = panier.find(p => p.nom === nom);
  if (item) {
    item.quantité += quantite;
  } else {
    panier.push({ nom, prix, quantité: quantite });
  }
  sauvegarderPanier();
  afficherPanier();
  showToast(`${quantite}x ${nom} ajouté(s) au panier !`, 'success');
}

function calculerTotal() {
  let total = panier.reduce((sum, item) => sum + (item.prix * item.quantité), 0);

  // Appliquer la réduction du code promo
  if (codeValide) {
    total *= (1 - reduction / 100);
  }

  // Appliquer la réduction globale de l'événement
  if (reductionGlobale > 0) {
    total *= (1 - reductionGlobale / 100);
  }

  return Math.round(total);
}

function afficherPanier() {
  const liste = document.getElementById("liste-panier");
  const emptyCart = document.getElementById("empty-cart");
  const totalElement = document.getElementById("total-panier");
  const buyButton = document.getElementById("buy-button");

  const clearButton = document.getElementById("clear-cart-button");

  if (panier.length === 0) {
    emptyCart.classList.remove("hidden");
    liste.classList.add("hidden");
    totalElement.classList.add("hidden");
    buyButton.classList.add("hidden");
    clearButton.classList.add("hidden");
  } else {
    emptyCart.classList.add("hidden");
    liste.classList.remove("hidden");
    totalElement.classList.remove("hidden");
    buyButton.classList.remove("hidden");
    clearButton.classList.remove("hidden");

    liste.innerHTML = "";
    panier.forEach((p, index) => {
      const li = document.createElement("li");
      li.className = "bg-white/5 rounded-lg p-4 mb-2 flex items-center justify-between";
      li.innerHTML = `
        <div class="flex-1">
          <h4 class="font-bold text-white text-lg">${p.nom}</h4>
          <p class="text-yellow-400">${p.prix} cailloux × ${p.quantité} = ${p.prix * p.quantité} cailloux</p>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="modifierQuantite(${index}, -1)" class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full font-bold transition-all">−</button>
          <span class="text-white font-bold w-8 text-center">${p.quantité}</span>
          <button onclick="modifierQuantite(${index}, 1)" class="bg-green-500 hover:bg-green-600 text-white w-8 h-8 rounded-full font-bold transition-all">+</button>
          <button onclick="retirerDuPanier(${index})" class="ml-2 bg-gray-700 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-all">🗑️</button>
        </div>
      `;
      liste.appendChild(li);
    });

    totalElement.textContent = `Total : ${calculerTotal()} cailloux`;
  }
}

// Modifier la quantité d'un article
function modifierQuantite(index, change) {
  if (panier[index]) {
    panier[index].quantité += change;

    if (panier[index].quantité <= 0) {
      retirerDuPanier(index);
    } else {
      sauvegarderPanier();
      afficherPanier();
    }
  }
}

// Retirer un article du panier
function retirerDuPanier(index) {
  const article = panier[index];
  panier.splice(index, 1);
  sauvegarderPanier();
  afficherPanier();
  showToast(`${article.nom} retiré du panier`, 'info');
}

// Vider le panier
function viderPanier() {
  showConfirm(
    'Êtes-vous sûr de vouloir vider votre panier ?',
    function confirmVider() {
      panier = [];
      sauvegarderPanier();
      afficherPanier();
      showToast('Panier vidé !', 'info');
    }
  );
}

function acheter() {
  if (panier.length === 0) {
    showAlert("Votre panier est vide.");
    return;
  }

  if (!utilisateurConnecte) {
    showAlert("Veuillez vous connecter pour acheter.");
    return;
  }

  // Demander les informations de livraison
  demanderInfosLivraison();
}

function demanderInfosLivraison() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] p-4';
  modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full shadow-2xl">
      <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">📦 Informations de livraison</h3>
      <p class="text-gray-700 dark:text-gray-300 mb-6">Pour finaliser votre achat, veuillez remplir ces informations :</p>

      <div class="space-y-4 mb-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">📞 Numéro de téléphone</label>
          <input type="text" id="delivery-phone" placeholder="Ex: 06 12 34 56 78" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base focus:ring-2 focus:ring-primary">
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">🏠 Adresse de livraison</label>
          <input type="text" id="delivery-address" placeholder="Ex: 123 rue de ton crâne" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base focus:ring-2 focus:ring-primary">
        </div>
      </div>

      <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-300 dark:border-yellow-700 rounded-lg p-4 mb-6">
        <p class="text-sm text-yellow-800 dark:text-yellow-300">
          ℹ️ Frais de livraison : <strong>+5%</strong> du total
        </p>
      </div>

      <div id="delivery-error" class="text-red-500 text-sm mb-4 hidden"></div>

      <div class="flex gap-3">
        <button class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-lg transition-colors" onclick="this.closest('.fixed').remove()">
          Annuler
        </button>
        <button class="flex-1 px-4 py-2 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-colors" onclick="validerLivraison()">
          Valider
        </button>
      </div>
    </div>
  `;
  document.getElementById('modal-container').appendChild(modal);
}

async function validerLivraison() {
  const phone = document.getElementById('delivery-phone').value.trim();
  const address = document.getElementById('delivery-address').value.trim();
  const errorDiv = document.getElementById('delivery-error');

  // Vérification : n'importe quelle valeur fonctionne, tant que c'est rempli
  if (!phone || !address) {
    errorDiv.textContent = "Veuillez remplir tous les champs.";
    errorDiv.classList.remove('hidden');
    return;
  }

  // Fermer la modale
  document.querySelector('#modal-container .fixed').remove();

  // Calculer le total avec frais de livraison (5%)
  const totalProduits = calculerTotal();
  const fraisLivraison = Math.round(totalProduits * 0.05);
  const totalFinal = totalProduits + fraisLivraison;

  // Vérifier le solde
  if (utilisateurs[utilisateurConnecte].solde >= totalFinal) {
    // Générer le numéro de commande
    const numeroCommande = genererNumeroCommande();

    // Mettre à jour les soldes
    await mettreAJourSolde(utilisateurConnecte, utilisateurs[utilisateurConnecte].solde - totalFinal);
    await mettreAJourSolde("HARMAN", utilisateurs["HARMAN"].solde + totalFinal);

    // Préparer les données de commande
    const commandeData = {
      utilisateur: utilisateurConnecte,
      numero: numeroCommande,
      date: new Date().toLocaleString('fr-FR'),
      articles: [...panier],
      total: totalFinal,
      adresse: address,
      telephone: phone,
      totalProduits: totalProduits,
      fraisLivraison: fraisLivraison
    };

    // Sauvegarder dans l'historique local
    if (!historique[utilisateurConnecte]) {
      historique[utilisateurConnecte] = [];
    }
    historique[utilisateurConnecte].push(commandeData);

    // Sauvegarder dans Firebase
    await sauvegarderCommande(commandeData);

    sendWebhook(`🛒 **NOUVELLE COMMANDE**\n📋 Numéro: **${numeroCommande}**\n👤 Client: ${utilisateurConnecte}\n📦 Livraison: ${address}\n📞 Tél: ${phone}\n💰 Total produits: ${totalProduits} cailloux\n🚚 Frais livraison: ${fraisLivraison} cailloux\n✅ Total final: ${totalFinal} cailloux\n\n📦 Articles:\n${panier.map(p => `  • ${p.nom} x${p.quantité} (${p.prix * p.quantité} cailloux)`).join('\n')}`);

    showAlert(`✅ Commande validée avec succès !\n\n📋 NUMÉRO DE COMMANDE :\n${numeroCommande}\n\n💰 Total produits : ${totalProduits} cailloux\n🚚 Frais de livraison : ${fraisLivraison} cailloux\n✅ TOTAL PAYÉ : ${totalFinal} cailloux\n\n📦 Livraison à : ${address}\n📞 Contact : ${phone}\n\n⚠️ Conservez votre numéro de commande !`);

    panier = [];
    codeValide = false;
    reduction = 0;
    sauvegarderPanier();
    afficherPanier();
    updateUserDisplay();
    afficherHistorique();
  } else {
    const montantManquant = totalFinal - utilisateurs[utilisateurConnecte].solde;
    showConfirm(
      `Solde insuffisant. Total avec livraison : ${totalFinal} cailloux.<br>Vous manquez ${montantManquant} cailloux.<br><br>Emprunter avec 5% d'intérêt ?`,
      async function handleCredit() {
        // Générer le numéro de commande
        const numeroCommande = genererNumeroCommande();

        const montantAvecInteret = Math.round(montantManquant * 1.05);

        // Mettre à jour les soldes
        await mettreAJourSolde(utilisateurConnecte, utilisateurs[utilisateurConnecte].solde - montantAvecInteret);
        await mettreAJourSolde("HARMAN", utilisateurs["HARMAN"].solde + totalFinal);

        // Préparer les données de commande
        const commandeData = {
          utilisateur: utilisateurConnecte,
          numero: numeroCommande,
          date: new Date().toLocaleString('fr-FR'),
          articles: [...panier],
          total: totalFinal,
          adresse: address,
          telephone: phone,
          credit: true,
          montantCredit: montantAvecInteret
        };

        // Sauvegarder dans l'historique local
        if (!historique[utilisateurConnecte]) {
          historique[utilisateurConnecte] = [];
        }
        historique[utilisateurConnecte].push(commandeData);

        // Sauvegarder dans Firebase
        await sauvegarderCommande(commandeData);

        sendWebhook(`💳 **COMMANDE AVEC CRÉDIT**\n📋 Numéro: **${numeroCommande}**\n👤 Client: ${utilisateurConnecte}\n💰 Crédit: ${montantAvecInteret} cailloux\n📦 Livraison: ${address}\n📞 Tél: ${phone}\n✅ Total: ${totalFinal} cailloux\n\n📦 Articles:\n${panier.map(p => `  • ${p.nom} x${p.quantité} (${p.prix * p.quantité} cailloux)`).join('\n')}`);
        showAlert(`✅ Crédit accordé ! Commande validée.\n\n📋 NUMÉRO DE COMMANDE :\n${numeroCommande}\n\n💰 Total : ${totalFinal} cailloux\n📦 Livraison à : ${address}\n\n⚠️ Conservez votre numéro de commande !`);

        panier = [];
        codeValide = false;
        reduction = 0;
        sauvegarderPanier();
        afficherPanier();
        updateUserDisplay();
        afficherHistorique();
      }
    );
  }
}

// Authentication
function toggleClassicLogin() {
  document.getElementById("classic-login-form").classList.toggle("hidden");
}

function handleClassicLogin(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  const identifiant = formData.get('identifiant').trim().toUpperCase();
  const motDePasse = formData.get('motDePasse').trim();

  if (utilisateurs[identifiant] && utilisateurs[identifiant].motDePasse === motDePasse) {
    login(identifiant);
  } else {
    document.getElementById("login-error").textContent = "Identifiant ou mot de passe incorrect.";
  }
}

async function login(username) {
  utilisateurConnecte = username;

  // Charger les données depuis Firebase
  await chargerUtilisateurs();

  // Vérifier si l'email est manquant
  if (!utilisateurs[username].email) {
    demanderEmail(username);
    return;
  }

  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("user-dashboard").classList.remove("hidden");

  // Afficher le menu admin si c'est HARMAN
  if (username === 'HARMAN' || username === 'ADMIN') {
    document.getElementById('admin-menu-btn').classList.remove('hidden');
  }

  // Afficher le menu messages
  document.getElementById('messages-menu-btn').classList.remove('hidden');

  // Initialiser la messagerie
  await initialiserMessagerie();

  await chargerHistorique(username);

  updateUserDisplay();
  afficherHistorique();
  tempQRUser = null;
  showToast(`Bienvenue ${username} ! 👋`, 'success');
}

// Demander l'email à la première connexion
function demanderEmail(username) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
  modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 md:p-8 max-w-md w-full shadow-2xl">
      <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">📧 Première connexion !</h3>
      <p class="text-gray-700 dark:text-gray-300 mb-6">Pour finaliser votre compte, veuillez ajouter votre adresse email.</p>

      <form id="email-setup-form" onsubmit="validerEmailSetup(event, '${username}')" class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">📧 Adresse Email (obligatoire)</label>
          <input type="email" id="email-input" placeholder="exemple@gmail.com" required class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base focus:ring-2 focus:ring-primary">
        </div>

        <div class="border-t border-gray-300 dark:border-gray-600 pt-4">
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">🔒 Changer le mot de passe (optionnel)</label>
          <input type="password" id="new-password-input" placeholder="Nouveau mot de passe (laissez vide pour garder l'ancien)" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base focus:ring-2 focus:ring-primary mb-2">
          <input type="password" id="confirm-password-input" placeholder="Confirmer le nouveau mot de passe" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base focus:ring-2 focus:ring-primary">
        </div>

        <div id="email-setup-error" class="text-red-500 text-sm hidden"></div>

        <button type="submit" class="w-full px-4 py-2 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-colors">
          ✅ Valider
        </button>
      </form>
    </div>
  `;
  document.getElementById('modal-container').appendChild(modal);
  setTimeout(() => document.getElementById('email-input').focus(), 100);
}

async function validerEmailSetup(event, username) {
  event.preventDefault();
  const email = document.getElementById('email-input').value.trim();
  const newPassword = document.getElementById('new-password-input').value.trim();
  const confirmPassword = document.getElementById('confirm-password-input').value.trim();
  const errorDiv = document.getElementById('email-setup-error');

  // Vérifier que les mots de passe correspondent si renseignés
  if (newPassword && newPassword !== confirmPassword) {
    errorDiv.textContent = "Les mots de passe ne correspondent pas.";
    errorDiv.classList.remove('hidden');
    return;
  }

  // Mettre à jour l'utilisateur
  const updateData = {
    email: email,
    emailVerifie: true
  };

  if (newPassword) {
    updateData.motDePasse = newPassword;
  }

  if (!db) {
    utilisateurs[username] = { ...utilisateurs[username], ...updateData };
  } else {
    try {
      await db.collection('utilisateurs').doc(username).update(updateData);
      utilisateurs[username] = { ...utilisateurs[username], ...updateData };
    } catch (error) {
      errorDiv.textContent = "Erreur lors de la mise à jour. Réessayez.";
      errorDiv.classList.remove('hidden');
      return;
    }
  }

  sendWebhook(`📧 **Email ajouté**\n👤 Utilisateur: ${username}\n✉️ Email: ${email}${newPassword ? '\n🔒 Mot de passe changé' : ''}`);

  // Fermer la modale et continuer la connexion
  document.querySelector('#modal-container .fixed').remove();

  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("user-dashboard").classList.remove("hidden");

  if (username === 'HARMAN' || username === 'ADMIN') {
    document.getElementById('admin-menu-btn').classList.remove('hidden');
  }

  await chargerHistorique(username);
  updateUserDisplay();
  afficherHistorique();
  showToast(`Bienvenue ${username} ! Email configuré avec succès ! 👋`, 'success');
}

async function logout() {
  // Mettre le statut hors ligne
  if (utilisateurConnecte && db) {
    await marquerHorsLigne();
  }

  utilisateurConnecte = null;
  conversationActive = null;
  document.getElementById("login-section").classList.remove("hidden");
  document.getElementById("user-dashboard").classList.add("hidden");
  document.getElementById("order-history").classList.add("hidden");
  document.getElementById('admin-menu-btn').classList.add('hidden');
  document.getElementById('messages-menu-btn').classList.add('hidden');
  showToast('Déconnexion réussie', 'info');
}

// Afficher l'historique des commandes
function afficherHistorique() {
  const historyDiv = document.getElementById("order-history");
  const historyList = document.getElementById("history-list");

  if (!utilisateurConnecte || !historique[utilisateurConnecte] || historique[utilisateurConnecte].length === 0) {
    historyDiv.classList.add("hidden");
    return;
  }

  historyDiv.classList.remove("hidden");
  historyList.innerHTML = '';

  const userOrders = historique[utilisateurConnecte].reverse();

  userOrders.forEach((order, index) => {
    const orderDiv = document.createElement('div');
    orderDiv.className = 'bg-white/5 rounded-lg p-4 mb-4';
    orderDiv.innerHTML = `
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-3">
        <div>
          <h4 class="text-xl font-bold text-yellow-400">📋 ${order.numero}</h4>
          <p class="text-sm text-white/70">🕒 ${order.date}</p>
        </div>
        <div class="mt-2 md:mt-0">
          <span class="text-2xl font-bold text-white">${order.total} cailloux</span>
          ${order.credit ? '<span class="ml-2 text-xs bg-orange-500 text-white px-2 py-1 rounded">💳 Crédit</span>' : ''}
        </div>
      </div>
      <div class="border-t border-white/10 pt-3 mt-3">
        <p class="text-sm text-white mb-2"><strong>📦 Articles :</strong></p>
        <ul class="text-sm text-white/80 space-y-1 ml-4">
          ${order.articles.map(a => `<li>• ${a.nom} x${a.quantité} (${a.prix * a.quantité} cailloux)</li>`).join('')}
        </ul>
        <p class="text-sm text-white mt-3"><strong>🏠 Adresse :</strong> ${order.adresse}</p>
        <p class="text-sm text-white"><strong>📞 Téléphone :</strong> ${order.telephone}</p>
      </div>
    `;
    historyList.appendChild(orderDiv);
  });
}

function updateUserDisplay() {
  if (utilisateurConnecte) {
    document.getElementById("user-name").textContent = utilisateurConnecte;
    document.getElementById("user-balance").textContent = utilisateurs[utilisateurConnecte].solde.toLocaleString('fr-FR');
  }
}

// QR Scanner
function startQRScanner() {
  qrScannerActive = true;
  document.getElementById("qr-scanner-overlay").classList.remove("hidden");
  document.getElementById("scan-message").textContent = "Initialisation...";

  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(stream => {
      const video = document.getElementById("qr-video");
      video.srcObject = stream;
      video.play();
      document.getElementById("scan-message").textContent = "Placez le QR code dans le cadre";
      scanQRCode();
    })
    .catch(err => {
      console.error('Erreur caméra:', err);
      document.getElementById("scan-message").textContent = "Impossible d'accéder à la caméra.";
    });
}

function scanQRCode() {
  if (!qrScannerActive) return;

  const video = document.getElementById("qr-video");
  const canvas = document.getElementById("qr-canvas");
  const context = canvas.getContext('2d');

  if (video.readyState < video.HAVE_ENOUGH_DATA) {
    animationId = requestAnimationFrame(scanQRCode);
    return;
  }

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  context.drawImage(video, 0, 0, canvas.width, canvas.height);

  const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
  let code = null;

  try {
    code = jsQR(imageData.data, imageData.width, imageData.height);
  } catch (e) {
    console.error("Erreur jsQR:", e);
  }

  if (code) {
    handleQRCodeDetected(code.data);
    return;
  }

  if (qrScannerActive) {
    animationId = requestAnimationFrame(scanQRCode);
  }
}

function handleQRCodeDetected(qrData) {
  const userId = qrData.trim().toUpperCase();

  if (utilisateurs[userId]) {
    stopQRScanner();

    if (qrSecretCodes[userId]) {
      tempQRUser = userId;
      document.getElementById("qr-user-prompt").textContent = `Veuillez entrer votre code secret pour ${userId}.`;
      document.getElementById("qr-code-verification-overlay").classList.remove("hidden");
    } else {
      login(userId);
      sendWebhook(`🔍 Connexion QR simple pour ${userId}`);
    }
  } else {
    document.getElementById("scan-message").textContent = `Code QR invalide: ${userId}`;
    setTimeout(() => {
      document.getElementById("scan-message").textContent = "Placez le QR code dans le cadre";
    }, 2000);
  }
}

function handleQRVerify(event) {
  event.preventDefault();
  const codeSecret = document.getElementById("qr-secret-code").value.trim();
  const errorDiv = document.getElementById("qr-verify-error");

  if (!tempQRUser) {
    errorDiv.textContent = "Erreur: Utilisateur QR non défini.";
    return;
  }

  if (qrSecretCodes[tempQRUser] === codeSecret) {
    document.getElementById("qr-code-verification-overlay").classList.add("hidden");
    login(tempQRUser);
    sendWebhook(`✅ Connexion QR avec code secret pour ${tempQRUser}`);
    document.getElementById("qr-secret-code").value = '';
  } else {
    errorDiv.textContent = "Code secret incorrect.";
  }
}

function cancelQRVerify() {
  tempQRUser = null;
  document.getElementById("qr-secret-code").value = '';
  document.getElementById("qr-verify-error").textContent = '';
  document.getElementById("qr-code-verification-overlay").classList.add("hidden");
}

function stopQRScanner() {
  qrScannerActive = false;

  if (animationId) {
    cancelAnimationFrame(animationId);
  }

  const video = document.getElementById("qr-video");
  if (video.srcObject) {
    video.srcObject.getTracks().forEach(track => track.stop());
  }

  document.getElementById("qr-scanner-overlay").classList.add("hidden");
}

// Transfers
async function envoyerCailloux(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  const destinataire = formData.get('destinataire').trim().toUpperCase();
  const montant = parseInt(formData.get('montant'));

  if (utilisateurs[destinataire] && montant > 0 && utilisateurs[utilisateurConnecte].solde >= montant) {
    // Mettre à jour les soldes dans Firebase
    await mettreAJourSolde(utilisateurConnecte, utilisateurs[utilisateurConnecte].solde - montant);
    await mettreAJourSolde(destinataire, utilisateurs[destinataire].solde + montant);

    showToast(`Virement de ${montant} cailloux effectué vers ${destinataire} ✅`, 'success');
    sendWebhook(`💸 Virement de ${montant} cailloux de ${utilisateurConnecte} à ${destinataire}.`);
    updateUserDisplay();
    event.target.reset();
  } else {
    showToast('Erreur : destinataire inconnu ou solde insuffisant', 'error');
  }
}

// Creator codes
function handleCodeInput(event) {
  if (event.key === 'Enter') {
    const code = event.target.value.trim().toUpperCase();
    const successDiv = document.getElementById("code-success");

    if (codes[code]) {
      codeValide = true;
      reduction = codes[code];
      successDiv.textContent = `✅ Code validé ! ${reduction}% de réduction`;
      successDiv.classList.remove("hidden");
      afficherPanier();
      showToast(`Code promo activé : -${reduction}% ! 🎉`, 'success');
    } else {
      codeValide = false;
      reduction = 0;
      successDiv.classList.add("hidden");
      showToast("Code promo invalide", 'error');
    }
    event.target.value = '';
  }
}

// Fonctions Admin
function toggleImageUrl(type) {
  const emojiInput = document.getElementById('emoji-input');
  const imageInput = document.getElementById('image-input');

  if (type === 'emoji') {
    emojiInput.classList.remove('hidden');
    imageInput.classList.add('hidden');
  } else {
    emojiInput.classList.add('hidden');
    imageInput.classList.remove('hidden');
  }
}

async function ajouterCailloux(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  const username = formData.get('username').trim().toUpperCase();
  const montant = parseInt(formData.get('montant'));

  if (!utilisateurs[username]) {
    showToast('Utilisateur inconnu !', 'error');
    return;
  }

  const nouveauSolde = utilisateurs[username].solde + montant;
  await mettreAJourSolde(username, nouveauSolde);

  sendWebhook(`⚙️ **ADMIN** - Modification de solde\n👤 Utilisateur: ${username}\n💰 Changement: ${montant > 0 ? '+' : ''}${montant} cailloux\n✅ Nouveau solde: ${nouveauSolde} cailloux`);

  showToast(`${montant > 0 ? 'Ajouté' : 'Retiré'} ${Math.abs(montant)} cailloux ${montant > 0 ? 'à' : 'de'} ${username}`, 'success');
  event.target.reset();

  if (utilisateurConnecte === username) {
    updateUserDisplay();
  }
}

async function ajouterProduit(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  const nom = formData.get('nom').trim();
  const prix = parseInt(formData.get('prix'));
  const type = formData.get('type');
  const limite = document.getElementById('produit-limite').checked;

  const nouvelArticle = { nom, prix, limite: limite };

  if (type === 'emoji') {
    const emoji = formData.get('emoji').trim();
    if (!emoji) {
      showToast('Veuillez entrer un emoji !', 'error');
      return;
    }
    nouvelArticle.emoji = emoji;
  } else {
    const imageUrl = formData.get('imageUrl').trim();
    if (!imageUrl) {
      showToast('Veuillez entrer une URL d\'image !', 'error');
      return;
    }
    nouvelArticle.img = imageUrl;
  }

  // Si limité, ajouter la date d'expiration (1 jour)
  if (limite) {
    const expireDate = new Date();
    expireDate.setDate(expireDate.getDate() + 1); // +1 jour
    nouvelArticle.expireAt = expireDate;
  }

  // Sauvegarder dans Firebase
  if (db) {
    try {
      await db.collection('articles').add({
        ...nouvelArticle,
        createdAt: new Date()
      });
    } catch (error) {
      showToast('Erreur lors de l\'ajout du produit', 'error');
      return;
    }
  } else {
    articles.push(nouvelArticle);
    afficherArticles();
  }

  sendWebhook(`⚙️ **ADMIN** - Nouveau produit ajouté\n📦 Nom: ${nom}\n💰 Prix: ${prix} cailloux\n${type === 'emoji' ? '😀 Emoji: ' + nouvelArticle.emoji : '🖼️ Image: ' + nouvelArticle.img}${limite ? '\n⏰ LIMITÉ - Expire dans 1 jour' : ''}`);

  showToast(`Produit "${nom}" ajouté${limite ? ' (limité 1 jour)' : ''} !`, 'success');
  event.target.reset();
}

const themes = {
  halloween: {
    nom: 'Halloween',
    emoji: '🎃',
    colors: {
      from: 'from-orange-600',
      via: 'via-purple-600',
      to: 'to-black'
    }
  },
  noel: {
    nom: 'Noël',
    emoji: '🎄',
    colors: {
      from: 'from-red-600',
      via: 'via-green-600',
      to: 'to-white'
    }
  },
  paques: {
    nom: 'Pâques',
    emoji: '🐰',
    colors: {
      from: 'from-pink-400',
      via: 'via-yellow-300',
      to: 'to-blue-300'
    }
  },
  'nouvel-an': {
    nom: 'Nouvel An',
    emoji: '🎆',
    colors: {
      from: 'from-yellow-500',
      via: 'via-purple-500',
      to: 'to-blue-500'
    }
  },
  'st-valentin': {
    nom: 'St Valentin',
    emoji: '💕',
    colors: {
      from: 'from-pink-500',
      via: 'via-red-500',
      to: 'to-pink-600'
    }
  },
  ldc: {
    nom: 'Ligue des Champions',
    emoji: '⚽',
    colors: {
      from: 'from-blue-900',
      via: 'via-blue-600',
      to: 'to-blue-900'
    }
  },
  'ballon-dor': {
    nom: 'Ballon d\'Or',
    emoji: '🏆',
    colors: {
      from: 'from-yellow-600',
      via: 'via-yellow-400',
      to: 'to-yellow-600'
    }
  },
  'coupe-monde': {
    nom: 'Coupe du Monde',
    emoji: '🏆',
    colors: {
      from: 'from-green-600',
      via: 'via-yellow-500',
      to: 'to-blue-600'
    }
  },
  normal: {
    nom: 'Normal',
    emoji: '⭐',
    colors: {
      from: 'from-blue-600',
      via: 'via-cyan-400',
      to: 'to-blue-600'
    }
  }
};

function changerTheme(themeId) {
  if (themeId !== 'normal') {
    // Demander le pourcentage de réduction
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] p-4';
    modal.innerHTML = `
      <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full shadow-2xl">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">${themes[themeId].emoji} ${themes[themeId].nom}</h3>
        <p class="text-gray-700 dark:text-gray-300 mb-6">Quelle réduction globale voulez-vous appliquer ?</p>
        <input type="number" id="reduction-input" min="0" max="100" value="10" placeholder="Ex: 10" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base mb-4 focus:ring-2 focus:ring-primary">
        <div class="flex gap-3">
          <button class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-lg transition-colors" onclick="this.closest('.fixed').remove()">
            Annuler
          </button>
          <button class="flex-1 px-4 py-2 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-colors" onclick="appliquerTheme('${themeId}', parseInt(document.getElementById('reduction-input').value)); this.closest('.fixed').remove()">
            Appliquer
          </button>
        </div>
      </div>
    `;
    document.getElementById('modal-container').appendChild(modal);
  } else {
    appliquerTheme('normal', 0);
  }
}

async function appliquerTheme(themeId, reductionPct, sauvegarder = true) {
  themeActuel = themeId;
  reductionGlobale = reductionPct || 0;

  const theme = themes[themeId];
  const body = document.body;

  // Supprimer les anciennes classes de couleur
  body.className = body.className.replace(/from-\S+/g, '').replace(/via-\S+/g, '').replace(/to-\S+/g, '');

  // Ajouter les nouvelles classes
  body.classList.add('bg-gradient-to-br', theme.colors.from, theme.colors.via, theme.colors.to);

  // Mettre à jour l'affichage
  document.getElementById('current-theme').textContent = `${theme.emoji} ${theme.nom}`;
  document.getElementById('current-reduction').textContent = `${reductionGlobale}%`;

  // Mettre à jour le panier pour refléter la nouvelle réduction
  afficherPanier();

  // Sauvegarder dans Firebase pour que tous les utilisateurs voient le changement
  if (sauvegarder) {
    await sauvegarderParametresGlobaux();
    sendWebhook(`⚙️ **ADMIN** - Changement de thème\n🎨 Nouveau thème: ${theme.emoji} ${theme.nom}\n💰 Réduction globale: ${reductionGlobale}%`);
    showToast(`Thème "${theme.nom}" activé pour TOUS ${reductionGlobale > 0 ? `avec ${reductionGlobale}% de réduction` : ''} !`, 'success');
  }
}

// Afficher les paramètres du compte
function afficherParametresCompte() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
  modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 md:p-8 max-w-md w-full shadow-2xl">
      <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">⚙️ Paramètres du compte</h3>

      <form id="account-settings-form" onsubmit="validerParametresCompte(event)" class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">📧 Email actuel</label>
          <p class="text-gray-900 dark:text-white font-semibold mb-2">${utilisateurs[utilisateurConnecte].email || 'Aucun email'}</p>
          <input type="email" id="new-email-input" placeholder="Nouvel email (optionnel)" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base focus:ring-2 focus:ring-primary">
        </div>

        <div class="border-t border-gray-300 dark:border-gray-600 pt-4">
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">🔒 Changer le mot de passe (optionnel)</label>
          <input type="password" id="settings-new-password" placeholder="Nouveau mot de passe" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base focus:ring-2 focus:ring-primary mb-2">
          <input type="password" id="settings-confirm-password" placeholder="Confirmer le mot de passe" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base focus:ring-2 focus:ring-primary">
        </div>

        <div id="settings-error" class="text-red-500 text-sm hidden"></div>

        <div class="flex gap-3">
          <button type="button" class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-lg transition-colors" onclick="this.closest('.fixed').remove()">
            Annuler
          </button>
          <button type="submit" class="flex-1 px-4 py-2 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-colors">
            💾 Sauvegarder
          </button>
        </div>
      </form>
    </div>
  `;
  document.getElementById('modal-container').appendChild(modal);
}

async function validerParametresCompte(event) {
  event.preventDefault();
  const newEmail = document.getElementById('new-email-input').value.trim();
  const newPassword = document.getElementById('settings-new-password').value.trim();
  const confirmPassword = document.getElementById('settings-confirm-password').value.trim();
  const errorDiv = document.getElementById('settings-error');

  if (newPassword && newPassword !== confirmPassword) {
    errorDiv.textContent = "Les mots de passe ne correspondent pas.";
    errorDiv.classList.remove('hidden');
    return;
  }

  const updateData = {};
  let changed = false;

  if (newEmail && newEmail !== utilisateurs[utilisateurConnecte].email) {
    updateData.email = newEmail;
    changed = true;
  }

  if (newPassword) {
    updateData.motDePasse = newPassword;
    changed = true;
  }

  if (!changed) {
    showToast('Aucune modification à sauvegarder', 'info');
    document.querySelector('#modal-container .fixed').remove();
    return;
  }

  if (db) {
    try {
      await db.collection('utilisateurs').doc(utilisateurConnecte).update(updateData);
      utilisateurs[utilisateurConnecte] = { ...utilisateurs[utilisateurConnecte], ...updateData };
    } catch (error) {
      errorDiv.textContent = "Erreur lors de la mise à jour.";
      errorDiv.classList.remove('hidden');
      return;
    }
  } else {
    utilisateurs[utilisateurConnecte] = { ...utilisateurs[utilisateurConnecte], ...updateData };
  }

  sendWebhook(`⚙️ **Paramètres modifiés**\n👤 Utilisateur: ${utilisateurConnecte}${newEmail ? '\n✉️ Nouvel email: ' + newEmail : ''}${newPassword ? '\n🔒 Mot de passe changé' : ''}`);

  showToast('Paramètres mis à jour avec succès !', 'success');
  document.querySelector('#modal-container .fixed').remove();
}

// ========== SYSTÈME DE MESSAGERIE ==========

// Initialiser la messagerie
async function initialiserMessagerie() {
  if (!utilisateurConnecte) return;

  // Afficher l'interface ou le message de connexion
  const loginRequired = document.getElementById('messages-login-required');
  const messagesInterface = document.getElementById('messages-interface');

  loginRequired.classList.add('hidden');
  messagesInterface.classList.remove('hidden');

  // Initialiser la photo de profil
  const profileData = await chargerPhotoProfil(utilisateurConnecte);
  document.getElementById('user-profile-pic').src = profileData.photoUrl;
  document.getElementById('messages-username').textContent = utilisateurConnecte;

  // Marquer l'utilisateur comme en ligne
  await marquerEnLigne();

  // Charger les conversations
  await chargerConversations();

  // Afficher la liste des utilisateurs
  afficherListeUtilisateurs();

  // Écouter les messages en temps réel
  ecouterMessages();

  // Écouter les statuts en ligne
  ecouterStatutsEnLigne();
}

// Marquer l'utilisateur comme en ligne
async function marquerEnLigne() {
  if (!db || !utilisateurConnecte) return;

  try {
    await db.collection('presence').doc(utilisateurConnecte).set({
      enLigne: true,
      derniereSeen: new Date()
    });
  } catch (error) {
    console.warn("Erreur marquer en ligne:", error);
  }
}

// Marquer l'utilisateur comme hors ligne
async function marquerHorsLigne() {
  if (!db || !utilisateurConnecte) return;

  try {
    await db.collection('presence').doc(utilisateurConnecte).set({
      enLigne: false,
      derniereSeen: new Date()
    });
  } catch (error) {
    console.warn("Erreur marquer hors ligne:", error);
  }
}

// Écouter les statuts en ligne
function ecouterStatutsEnLigne() {
  if (!db) return;

  db.collection('presence').onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      const username = change.doc.id;
      const data = change.doc.data();

      if (data.enLigne) {
        utilisateursEnLigne.add(username);
      } else {
        utilisateursEnLigne.delete(username);
      }
    });

    // Mettre à jour l'affichage
    afficherListeUtilisateurs();
    if (conversationActive) {
      updateConversationStatus();
    }
  });
}

// Charger la photo de profil
async function chargerPhotoProfil(username) {
  if (!db) {
    return { photoUrl: `https://ui-avatars.com/api/?name=${username}&background=5D5CDE&color=fff&size=128` };
  }

  try {
    const doc = await db.collection('profils').doc(username).get();
    if (doc.exists && doc.data().photoUrl) {
      return doc.data();
    }
  } catch (error) {
    console.warn("Erreur chargement photo:", error);
  }

  return { photoUrl: `https://ui-avatars.com/api/?name=${username}&background=5D5CDE&color=fff&size=128` };
}

// Changer la photo de profil
function changerPhotoProfil() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] p-4';
  modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full shadow-2xl">
      <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">📷 Changer la photo de profil</h3>
      <p class="text-gray-700 dark:text-gray-300 mb-4">Entrez l'URL de votre photo :</p>
      <input type="url" id="photo-url-input" placeholder="https://..." class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base mb-4 focus:ring-2 focus:ring-primary">
      <div class="flex gap-3">
        <button class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-lg transition-colors" onclick="this.closest('.fixed').remove()">
          Annuler
        </button>
        <button class="flex-1 px-4 py-2 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-colors" onclick="sauvegarderPhotoProfil(); this.closest('.fixed').remove()">
          Valider
        </button>
      </div>
    </div>
  `;
  document.getElementById('modal-container').appendChild(modal);
}

async function sauvegarderPhotoProfil() {
  const photoUrl = document.getElementById('photo-url-input').value.trim();

  if (!photoUrl) {
    showToast('Veuillez entrer une URL', 'error');
    return;
  }

  if (!db) {
    document.getElementById('user-profile-pic').src = photoUrl;
    showToast('Photo de profil mise à jour !', 'success');
    return;
  }

  try {
    await db.collection('profils').doc(utilisateurConnecte).set({
      photoUrl: photoUrl,
      updatedAt: new Date()
    });
    document.getElementById('user-profile-pic').src = photoUrl;
    showToast('Photo de profil mise à jour !', 'success');
  } catch (error) {
    showToast('Erreur lors de la sauvegarde', 'error');
  }
}

// Afficher la liste des utilisateurs
async function afficherListeUtilisateurs() {
  const usersList = document.getElementById('users-list');
  usersList.innerHTML = '';

  const autresUtilisateurs = Object.keys(utilisateurs).filter(u => u !== utilisateurConnecte).sort();

  for (const username of autresUtilisateurs) {
    const profileData = await chargerPhotoProfil(username);
    const enLigne = utilisateursEnLigne.has(username);

    // Compter les messages non lus
    const nonLus = messagesNonLus[username] || 0;

    const userDiv = document.createElement('div');
    userDiv.className = 'bg-white/5 hover:bg-white/10 rounded-lg p-3 cursor-pointer transition-all flex items-center gap-3 relative';
    userDiv.onclick = () => ouvrirConversation(username);
    userDiv.innerHTML = `
      <div class="relative">
        <img src="${profileData.photoUrl}" alt="${username}" class="w-12 h-12 rounded-full border-2 ${enLigne ? 'border-green-500' : 'border-gray-500'}">
        <span class="absolute bottom-0 right-0 w-3 h-3 ${enLigne ? 'bg-green-500' : 'bg-gray-500'} rounded-full border-2 border-white"></span>
      </div>
      <div class="flex-1">
        <p class="text-white font-semibold">${username}</p>
        <p class="text-xs ${enLigne ? 'text-green-400' : 'text-gray-400'}">${enLigne ? '● En ligne' : '○ Hors ligne'}</p>
      </div>
      ${nonLus > 0 ? `<span class="bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">${nonLus}</span>` : ''}
    `;
    usersList.appendChild(userDiv);
  }
}

function filtrerUtilisateurs() {
  const recherche = document.getElementById('user-search').value.toLowerCase();
  const users = document.querySelectorAll('#users-list > div');

  users.forEach(userDiv => {
    const username = userDiv.textContent.toLowerCase();
    if (username.includes(recherche)) {
      userDiv.style.display = 'flex';
    } else {
      userDiv.style.display = 'none';
    }
  });
}

// Ouvrir une conversation
async function ouvrirConversation(username) {
  conversationActive = username;

  // Masquer le message de bienvenue
  document.getElementById('no-conversation-selected').classList.add('hidden');
  document.getElementById('active-conversation').classList.remove('hidden');

  // Charger la photo de profil
  const profileData = await chargerPhotoProfil(username);
  document.getElementById('conv-user-pic').src = profileData.photoUrl;
  document.getElementById('conv-username').textContent = username;

  // Mettre à jour le statut
  updateConversationStatus();

  // Charger les messages
  await chargerMessagesConversation(username);

  // Marquer les messages comme lus
  messagesNonLus[username] = 0;
  afficherListeUtilisateurs();
  updateUnreadBadge();
}

function updateConversationStatus() {
  if (!conversationActive) return;

  const enLigne = utilisateursEnLigne.has(conversationActive);
  const statusElement = document.getElementById('conv-status');
  statusElement.innerHTML = enLigne
    ? '<span class="text-green-400">● En ligne</span>'
    : '<span class="text-gray-400">○ Hors ligne</span>';

  // Mettre à jour la bordure de la photo
  const pic = document.getElementById('conv-user-pic');
  pic.className = `w-12 h-12 rounded-full border-2 ${enLigne ? 'border-green-500' : 'border-gray-500'}`;
}

function fermerConversation() {
  conversationActive = null;
  document.getElementById('no-conversation-selected').classList.remove('hidden');
  document.getElementById('active-conversation').classList.add('hidden');
}

// Charger les conversations
async function chargerConversations() {
  if (!db || !utilisateurConnecte) return;

  try {
    const snapshot = await db.collection('messages')
      .where('participants', 'array-contains', utilisateurConnecte)
      .get();

    snapshot.forEach(doc => {
      const data = doc.data();
      const conversationId = doc.id;

      if (!conversations[conversationId]) {
        conversations[conversationId] = [];
      }
    });
  } catch (error) {
    console.warn("Erreur chargement conversations:", error);
  }
}

// Charger les messages d'une conversation
async function chargerMessagesConversation(autreUtilisateur) {
  const container = document.getElementById('messages-container');
  container.innerHTML = '<p class="text-white/50 text-center">Chargement...</p>';

  if (!db) {
    container.innerHTML = '<p class="text-white/50 text-center">Mode hors ligne - Messages non disponibles</p>';
    return;
  }

  try {
    const conversationId = [utilisateurConnecte, autreUtilisateur].sort().join('_');

    const snapshot = await db.collection('messages')
      .doc(conversationId)
      .collection('msgs')
      .orderBy('timestamp', 'asc')
      .get();

    container.innerHTML = '';

    if (snapshot.empty) {
      container.innerHTML = '<p class="text-white/50 text-center">Aucun message. Commencez la conversation ! 👋</p>';
      return;
    }

    snapshot.forEach(doc => {
      const msg = doc.data();
      afficherMessage(msg);
    });

    // Scroller vers le bas
    container.scrollTop = container.scrollHeight;
  } catch (error) {
    console.warn("Erreur chargement messages:", error);
    container.innerHTML = '<p class="text-red-400 text-center">Erreur de chargement</p>';
  }
}

// Afficher un message
function afficherMessage(msg) {
  const container = document.getElementById('messages-container');
  const isMe = msg.from === utilisateurConnecte;

  const msgDiv = document.createElement('div');
  msgDiv.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;

  let contenu = '';
  if (msg.type === 'text') {
    contenu = `<p class="break-words">${msg.text}</p>`;
  } else if (msg.type === 'image') {
    contenu = `<img src="${msg.url}" alt="Image" class="max-w-xs rounded-lg cursor-pointer" onclick="window.open('${msg.url}', '_blank')">`;
  } else if (msg.type === 'video') {
    contenu = `<video src="${msg.url}" controls class="max-w-xs rounded-lg"></video>`;
  } else if (msg.type === 'gif') {
    contenu = `<img src="${msg.url}" alt="GIF" class="max-w-xs rounded-lg">`;
  }

  msgDiv.innerHTML = `
    <div class="max-w-[70%]">
      <div class="${isMe ? 'bg-primary' : 'bg-white/10'} text-white rounded-2xl px-4 py-2">
        ${contenu}
      </div>
      <p class="text-xs text-white/50 mt-1 ${isMe ? 'text-right' : 'text-left'}">${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : ''}</p>
    </div>
  `;

  container.appendChild(msgDiv);
  container.scrollTop = container.scrollHeight;
}

// Écouter les nouveaux messages en temps réel
function ecouterMessages() {
  if (!db || !utilisateurConnecte) return;

  Object.keys(utilisateurs).forEach(autreUtilisateur => {
    if (autreUtilisateur === utilisateurConnecte) return;

    const conversationId = [utilisateurConnecte, autreUtilisateur].sort().join('_');

    db.collection('messages')
      .doc(conversationId)
      .collection('msgs')
      .orderBy('timestamp', 'desc')
      .limit(1)
      .onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === 'added') {
            const msg = change.doc.data();

            // Si c'est un nouveau message et que ce n'est pas de nous
            if (msg.from !== utilisateurConnecte) {
              // Si la conversation n'est pas ouverte, compter comme non lu
              if (conversationActive !== autreUtilisateur) {
                messagesNonLus[autreUtilisateur] = (messagesNonLus[autreUtilisateur] || 0) + 1;
                afficherListeUtilisateurs();
                updateUnreadBadge();

                // Notification toast
                showToast(`💬 Nouveau message de ${msg.from}`, 'info');
              } else {
                // Si la conversation est ouverte, afficher le message
                afficherMessage(msg);
              }
            }
          }
        });
      });
  });
}

// Mettre à jour le badge de messages non lus
function updateUnreadBadge() {
  const total = Object.values(messagesNonLus).reduce((sum, count) => sum + count, 0);
  const badge = document.getElementById('unread-badge');

  if (total > 0) {
    badge.textContent = total > 99 ? '99+' : total;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

// Envoyer un message
async function envoyerMessage(type = 'text', url = null) {
  const input = document.getElementById('message-input');
  const text = input.value.trim();

  if (!conversationActive) {
    showToast('Aucune conversation sélectionnée', 'error');
    return;
  }

  if (type === 'text' && !text) {
    showToast('Le message est vide', 'error');
    return;
  }

  if (!db) {
    showToast('Mode hors ligne - Messages non disponibles', 'error');
    return;
  }

  try {
    const conversationId = [utilisateurConnecte, conversationActive].sort().join('_');

    const messageData = {
      from: utilisateurConnecte,
      to: conversationActive,
      type: type,
      timestamp: new Date()
    };

    if (type === 'text') {
      messageData.text = text;
    } else {
      messageData.url = url;
    }

    // Sauvegarder le message
    await db.collection('messages')
      .doc(conversationId)
      .collection('msgs')
      .add(messageData);

    // Créer ou mettre à jour le document de conversation
    await db.collection('messages').doc(conversationId).set({
      participants: [utilisateurConnecte, conversationActive],
      lastMessage: new Date()
    }, { merge: true });

    // Afficher le message localement
    afficherMessage(messageData);

    // Réinitialiser l'input
    input.value = '';
  } catch (error) {
    console.warn("Erreur envoi message:", error);
    showToast('Erreur lors de l\'envoi', 'error');
  }
}

function handleMessageKeyPress(event) {
  if (event.key === 'Enter') {
    envoyerMessage();
  }
}

// Ajouter une image
function ajouterImage() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] p-4';
  modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full shadow-2xl">
      <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">🖼️ Ajouter une image</h3>
      <input type="url" id="image-url-input" placeholder="https://..." class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base mb-4 focus:ring-2 focus:ring-primary">
      <div class="flex gap-3">
        <button class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-lg transition-colors" onclick="this.closest('.fixed').remove()">
          Annuler
        </button>
        <button class="flex-1 px-4 py-2 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-colors" onclick="envoyerMediaUrl('image'); this.closest('.fixed').remove()">
          Envoyer
        </button>
      </div>
    </div>
  `;
  document.getElementById('modal-container').appendChild(modal);
}

// Ajouter un GIF
function ajouterGif() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] p-4';
  modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full shadow-2xl">
      <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">GIF Ajouter un GIF</h3>
      <input type="url" id="gif-url-input" placeholder="https://..." class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base mb-4 focus:ring-2 focus:ring-primary">
      <div class="flex gap-3">
        <button class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-lg transition-colors" onclick="this.closest('.fixed').remove()">
          Annuler
        </button>
        <button class="flex-1 px-4 py-2 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-colors" onclick="envoyerMediaUrl('gif'); this.closest('.fixed').remove()">
          Envoyer
        </button>
      </div>
    </div>
  `;
  document.getElementById('modal-container').appendChild(modal);
}

// Ajouter une vidéo
function ajouterVideo() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] p-4';
  modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full shadow-2xl">
      <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">🎥 Ajouter une vidéo</h3>
      <input type="url" id="video-url-input" placeholder="https://..." class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base mb-4 focus:ring-2 focus:ring-primary">
      <div class="flex gap-3">
        <button class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-lg transition-colors" onclick="this.closest('.fixed').remove()">
          Annuler
        </button>
        <button class="flex-1 px-4 py-2 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-colors" onclick="envoyerMediaUrl('video'); this.closest('.fixed').remove()">
          Envoyer
        </button>
      </div>
    </div>
  `;
  document.getElementById('modal-container').appendChild(modal);
}

function envoyerMediaUrl(type) {
  const inputId = type === 'image' ? 'image-url-input' : type === 'gif' ? 'gif-url-input' : 'video-url-input';
  const url = document.getElementById(inputId).value.trim();

  if (!url) {
    showToast('Veuillez entrer une URL', 'error');
    return;
  }

  envoyerMessage(type, url);
}

// Init
document.addEventListener('DOMContentLoaded', async function() {
  // Afficher l'écran de chargement pendant 5 secondes
  setTimeout(() => {
    const loadingScreen = document.getElementById('loading-screen');
    loadingScreen.style.opacity = '0';
    loadingScreen.style.transition = 'opacity 0.5s ease-out';
    setTimeout(() => {
      loadingScreen.remove();
    }, 500);
  }, 5000);

  // Initialiser Firebase et charger les données
  await initialiserUtilisateurs();

  afficherArticles();
  afficherPanier();
  updateCartBadge();
  sendWebhook("👀 Nouvelle visite sur **JOLIE PAS CHER** !");
});
</script>

</body>
</html>
